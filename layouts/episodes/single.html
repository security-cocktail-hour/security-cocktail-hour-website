{{ define "title" }}{{ if .Params.seo_title }}{{ .Params.seo_title }}{{ else }}{{ .Title }}{{ end }} | {{ .Site.Title }}{{ end }}

{{ define "head" }}
<!-- Podcast Episode Schema Markup -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "PodcastEpisode",
  "url": "{{ .Permalink }}",
  "name": "{{ .Title }}",
  "datePublished": "{{ .Date.Format "2006-01-02" }}",
  {{ with .Params.duration }}"timeRequired": "{{ . }}",{{ end }}
  "description": "{{ with .Description }}{{ . }}{{ else }}{{ .Summary }}{{ end }}",
  {{ with .Params.platforms.youtube }}
  "associatedMedia": {
    "@type": "MediaObject",
    "contentUrl": "{{ . }}"
  },
  {{ end }}
  "partOfSeries": {
    "@type": "PodcastSeries",
    "name": "{{ .Site.Title }}",
    "url": "{{ .Site.BaseURL }}"
  }
}
</script>
{{ end }}

{{ define "main" }}

<!-- Episode Header -->
<section class="section" style="background: linear-gradient(135deg, #436098 0%, #6A8CC7 100%); color: white; padding: 2rem 0;">
  <div class="container">
    <nav aria-label="Breadcrumb" style="margin-bottom: 1rem; font-size: 0.875rem;">
      <a href="{{ "/" | relURL }}" style="color: rgba(255, 255, 255, 0.8);">Home</a> &gt;
      <a href="{{ "/episodes" | relURL }}" style="color: rgba(255, 255, 255, 0.8);">Episodes</a> &gt;
      <span style="color: white;">{{ .Title }}</span>
    </nav>

    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      {{ with .File }}
        {{ $filename := .BaseFileName }}
        {{ if strings.HasPrefix $filename "episode-" }}
          {{ $parts := split $filename "-" }}
          {{ $epNum := index $parts 1 }}
          <span class="category-tag" style="background: rgba(255, 255, 255, 0.3);">Episode {{ $epNum }}</span>
        {{ end }}
      {{ end }}
      {{ with .Params.category }}
        <span class="category-tag" style="background: rgba(255, 255, 255, 0.2);">{{ . }}</span>
      {{ end }}
    </div>

    <h1 style="color: white; margin-bottom: 1rem;">{{ .Title }}</h1>

    <p style="font-size: 1.125rem; margin-bottom: 1.5rem; opacity: 0.95;">
      {{ with .Params.guest }}<strong>{{ . }}</strong> | {{ end }}
      {{ .Date.Format "January 2, 2006" }}
      {{ with .Params.duration }} | {{ . }}{{ end }}
    </p>

    <!-- Listen On Buttons -->
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      {{ with .Params.platforms.youtube }}
        <a href="{{ . }}" class="btn btn-primary" target="_blank" rel="noopener" style="background: #FF0000;">YouTube</a>
      {{ end }}
      {{ with .Params.platforms.spotify }}
        <a href="{{ . }}" class="btn btn-primary" target="_blank" rel="noopener" style="background: #1DB954;">Spotify</a>
      {{ end }}
      {{ with .Params.platforms.apple }}
        <a href="{{ . }}" class="btn btn-primary" target="_blank" rel="noopener" style="background: #9933CC;">Apple</a>
      {{ end }}
      {{ with .Params.platforms.amazon }}
        <a href="{{ . }}" class="btn btn-primary" target="_blank" rel="noopener" style="background: #FF9900;">Amazon</a>
      {{ end }}
    </div>
  </div>
</section>

<!-- Main Content with Sidebar -->
<section class="section">
  <div class="container">
    <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">

      <!-- Main Content Column -->
      <div style="grid-column: 1;">

        <!-- Episode Cover Image -->
        {{ with .Params.image }}
          <img src="{{ . | relURL }}" alt="{{ $.Title }}" style="width: 100%; max-width: 600px; border-radius: 8px; margin-bottom: 2rem;">
        {{ end }}

        <!-- Episode Description -->
        <div style="margin-bottom: 2rem;">
          {{ $content := .Content }}
          {{ $transcriptHeading := "<h2 id=\"full-episode-transcript\">Full Episode Transcript</h2>" }}

          {{ if in $content $transcriptHeading }}
            <!-- Split content at transcript heading -->
            {{ $parts := split $content $transcriptHeading }}
            {{ $beforeTranscript := index $parts 0 }}
            {{ $transcriptContent := index $parts 1 }}

            <!-- Render content before transcript -->
            {{ $beforeTranscript | safeHTML }}

            <!-- Transcript Accordion -->
            <div style="margin: 3rem 0;">
              <details id="transcript" style="border: 2px solid #436098; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(67, 96, 152, 0.1); overflow: hidden;">
                <summary style="padding: 1.25rem 1.5rem; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #436098 0%, #6A8CC7 100%); color: white; font-size: 1.25rem; font-weight: 600; user-select: none; transition: all 0.2s ease;">
                  <span>üìù Full Episode Transcript</span>
                  <span style="font-size: 1.5rem; transition: transform 0.3s ease;">‚ñº</span>
                </summary>
                <div style="padding: 2rem 1.5rem; line-height: 1.8; max-height: 600px; overflow-y: auto; border-top: 3px solid #E5E5E5;">
                  {{ $transcriptContent | safeHTML }}
                </div>
              </details>
            </div>

            <style>
              /* Rotate arrow when open */
              details[open] > summary span:last-child {
                transform: rotate(180deg);
              }

              /* Hover effect */
              details summary:hover {
                background: linear-gradient(135deg, #5874AD 0%, #7A9AD6 100%);
              }

              /* Hide default marker */
              details summary::-webkit-details-marker {
                display: none;
              }

              /* Smooth scroll for transcript */
              details[open] {
                scroll-margin-top: 2rem;
              }

              /* Transcript speaker styling */
              #transcript strong {
                color: #436098;
                display: inline-block;
                margin-top: 1rem;
              }

              /* Mobile responsive */
              @media (max-width: 768px) {
                details summary {
                  font-size: 1rem;
                  padding: 1rem;
                }
                details div {
                  padding: 1.5rem 1rem;
                  max-height: 400px;
                }
              }
            </style>

            <script>
              // Smooth scroll when opening transcript
              document.querySelector('#transcript')?.addEventListener('toggle', function(e) {
                if (this.open) {
                  setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }, 100);
                }
              });
            </script>

          {{ else }}
            <!-- No transcript, render content normally -->
            {{ .Content }}
          {{ end }}
        </div>

        <!-- Social Sharing -->
        <div style="border-top: 1px solid #E5E5E5; padding-top: 1.5rem; margin-top: 2rem;">
          <h4>Share This Episode</h4>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <a href="https://twitter.com/intent/tweet?text={{ .Title | urlquery }}&url={{ .Permalink | urlquery }}" target="_blank" rel="noopener" class="btn btn-secondary">Twitter</a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ .Permalink | urlquery }}" target="_blank" rel="noopener" class="btn btn-secondary">LinkedIn</a>
            <a href="mailto:?subject={{ .Title | urlquery }}&body={{ .Permalink | urlquery }}" class="btn btn-secondary">Email</a>
          </div>
        </div>

      </div>

      <!-- Sidebar Column (Desktop) -->
      <aside style="grid-column: 1;">

        <!-- Guest Bio Card (if guest info exists) -->
        {{ with .Params.guest_bio }}
          <div class="card" style="margin-bottom: 2rem; background: #F5F5F5;">
            <div class="card-content">
              <h4>About {{ $.Params.guest }}</h4>
              {{ with $.Params.guest_image }}
                <img src="{{ . | relURL }}" alt="{{ $.Params.guest }}" style="width: 100px; height: 100px; border-radius: 50%; margin: 1rem 0;">
              {{ end }}
              <p style="font-size: 0.875rem;">{{ . | markdownify }}</p>
              {{ with $.Params.guest_links }}
                <div style="margin-top: 1rem;">
                  {{ range . }}
                    <a href="{{ .url }}" target="_blank" rel="noopener" style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">{{ .name }}</a>
                  {{ end }}
                </div>
              {{ end }}
            </div>
          </div>
        {{ end }}

        <!-- Email Signup -->
        <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #B33333 0%, #D74444 100%) !important; color: white;">
          <div class="card-content" style="background: linear-gradient(135deg, #B33333 0%, #D74444 100%) !important;">
            <h4 style="color: white; margin-bottom: 0.75rem;">Join Our Newsletter</h4>
            <p style="font-size: 0.875rem; margin-bottom: 1.5rem; opacity: 0.95;">
              Get exclusive insights, show news and more delivered to your inbox.
            </p>
            <form action="https://securitycocktailhour.us4.list-manage.com/subscribe/post?u=5a12cbfb41bc7e9e08b7af3c6&amp;id=2eddec8bf9&amp;f_id=0098d0edf0" method="POST" target="_blank">
              <input
                type="email"
                name="EMAIL"
                placeholder="your@email.com"
                required
                style="width: 100%; padding: 0.875rem 1.25rem; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 4px; font-family: 'PT Serif', serif; font-size: 1rem; background: white; color: #2D2D2D; margin-bottom: 1rem; transition: all 0.3s ease;"
              >
              <div style="position: absolute; left: -5000px;" aria-hidden="true">
                <input type="text" name="b_5a12cbfb41bc7e9e08b7af3c6_2eddec8bf9" tabindex="-1" value="">
              </div>
              <button type="submit" name="subscribe" class="btn btn-primary" style="width: 100%; background: white; color: #D74444; padding: 0.875rem 1.5rem; font-weight: 600; border: 2px solid white; transition: all 0.3s ease;">
                Subscribe
              </button>
            </form>
          </div>
        </div>

        <!-- Related Episodes -->
        <div>
          <h4>Related Episodes</h4>
          <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
            {{ $related := slice }}
            {{ if .Params.related_episodes }}
              <!-- Use manually specified related episodes -->
              {{ range .Params.related_episodes }}
                {{ $episodePath := printf "episodes/%s" . }}
                {{ with $.Site.GetPage $episodePath }}
                  {{ $related = $related | append . }}
                {{ end }}
              {{ end }}
            {{ else }}
              <!-- Auto-generate related episodes by category -->
              {{ $related = where .Site.RegularPages "Type" "episodes" | intersect (where .Site.RegularPages ".Params.category" .Params.category) | first 3 }}
            {{ end }}
            {{ range $related }}
              {{ if ne .RelPermalink $.RelPermalink }}
                <a href="{{ .RelPermalink }}" class="card" style="text-decoration: none; display: block;">
                  <div style="display: flex; gap: 1rem; padding: 1rem;">
                    {{ with .Params.image }}
                      <img src="{{ . | relURL }}" alt="{{ $.Title }}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                    {{ end }}
                    <div>
                      <p style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.25rem; color: #436098;">{{ .Title }}</p>
                      <p style="font-size: 0.75rem; color: rgba(45, 45, 45, 0.7);">
                        {{ with .Params.guest }}{{ . }} | {{ end }}
                        {{ with .Params.duration }}{{ . }}{{ end }}
                      </p>
                    </div>
                  </div>
                </a>
              {{ end }}
            {{ end }}
          </div>
        </div>

      </aside>

    </div>
  </div>
</section>

<!-- Responsive Grid for Desktop -->
<style>
@media (min-width: 900px) {
  .section .container > div {
    grid-template-columns: 2fr 1fr !important;
  }
  .section .container > div > div:first-child {
    grid-column: 1 !important;
  }
  .section .container > div > aside {
    grid-column: 2 !important;
  }
}
</style>

{{ end }}
